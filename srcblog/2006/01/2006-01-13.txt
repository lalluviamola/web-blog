Date: 2006-01-13 23:42:02
Format: wphtml
Title: Debugging adventure

 This is a debugging story and the lessons learned.<br> <br> I was writing an application using a <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/mobilesdk5/html/wce51lrfmailswitchtoaccount.asp" title="MailSwitchToAccount">MailSwitchToAccount</a> API new in WIndows Mobile 5.0. According to docs it's defined in cemapi.h and an app needs to link with cemapi.lib.<br> <br> That's how I called it:<br> <br> <blockquote> hr = MailSwitchToAccount(_T("SMS"));    <br> </blockquote><br> Visual Studio 2005 refused to link the app, claiming that:<br> <br> <blockquote>TestDevice.obj : error LNK2019: unresolved external symbol "long __cdecl MailSwitchToAccount(wchar_t const *,unsigned long)" (?MailSwitchToAccount@@YAJPB_WK@Z) referenced in function "void __cdecl OnMailSwitchToAccount(void)" (?OnMailSwitchToAccount@@YAXXZ)<br> </blockquote><br> My first thought was that this symbol is simply missing from cemapi.lib. So I used dumpbin.exe (part of Visual Studio tools) to dump all symbols exported from cemapi.lib:<br> <blockquote>dumpbin -exports cemapi.lib<br> </blockquote><br> I found that it does have MailSwitchToAccount:<br> <br> <blockquote>?MailSwitchToAccount@@YAJPBGK@Z (long __cdecl MailSwitchToAccount(unsigned short const *,unsigned long))<br> </blockquote><br> Howerver, if you look closely, you'll see that signatures don't match: expected type for the first parameter is "unsigned short *" while I'm calling it as "wchar_t const *". Now, "unsigned short" is the WCHAR Windows UNICODE type. C++ also defines wchar_t which is also UNICODE char. <br> <br> I vaguely remembered that some C++ compilers have an option to treat wchar_t as a native language type (as opposed to just a typedef for existing type, "unsigned short" in Windows' case). At indeed, there it was, in project properties, C/C++/Language there's an option "Treat wchar_t as Built-in Type", set by default to Yes. You can set it to "No", which corresponds to passing "/Zc:wchar_t-" to cl.exe.<br> <br> It seems wrong that you have to do that. It seems like cemapi.dll/cemapi.lib were compiled with "/Zc:wchar_t-" which forces everyone who links to them also be compiled like that.<br> <br> Lessons learned:<br> <ul>   <li>     C++ is evil   </li><li>     dumpbin.exe is your friend   </li><li>     Visual Studio's code browsing is your friend (it's easy to find out what a given typedef or #define really is)   </li><li>     be aware of "wchar_t as built-in type or not" issue </li></ul> <br> <span style="font-weight: bold;">Update:</span> turns out it's a known problem and has been blogged about on official Visual Studio blog: <a title="http://blogs.msdn.com/vsdteam/archive/2005/11/16/linker_error_lnk2019_lnk2001.aspx" href="http://blogs.msdn.com/vsdteam/archive/2005/11/16/linker_error_lnk2019_lnk2001.aspx">http://blogs.msdn.com/vsdteam/archive/2005/11/16/linker_error_lnk2019_lnk2001.aspx</a>. Good news is that it will probably be fixed in future versions of Visual Studio.<br> <br>